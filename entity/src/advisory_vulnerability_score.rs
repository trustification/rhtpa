use crate::{advisory, advisory_vulnerability, cvss3, vulnerability};
use cvss::{v3, v4_0};
use sea_orm::entity::prelude::*;

#[derive(Clone, Debug, PartialEq, DeriveEntityModel)]
#[sea_orm(table_name = "advisory_vulnerability_score")]
pub struct Model {
    #[sea_orm(primary_key)]
    pub id: Uuid,

    pub advisory_id: Uuid,
    pub vulnerability_id: String,

    pub r#type: ScoreType,
    pub vector: String,
    pub score: f64,
    pub severity: Severity,
}

#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]
pub enum Relation {
    #[sea_orm(
        belongs_to = "super::advisory_vulnerability::Entity",
        from = "(super::advisory_vulnerability_score::Column::AdvisoryId, super::advisory_vulnerability_score::Column::VulnerabilityId)"
        to = "(super::advisory_vulnerability::Column::AdvisoryId, super::advisory_vulnerability::Column::VulnerabilityId)"
    )]
    AdvisoryVulnerability,
    #[sea_orm(
        belongs_to = "super::advisory::Entity",
        from = "super::advisory_vulnerability_score::Column::AdvisoryId"
        to = "super::advisory::Column::Id"
    )]
    Advisory,
    #[sea_orm(
        belongs_to = "super::vulnerability::Entity",
        from = "super::advisory_vulnerability_score::Column::VulnerabilityId"
        to = "super::vulnerability::Column::Id"
    )]
    Vulnerability,
}

impl Related<advisory::Entity> for Entity {
    fn to() -> RelationDef {
        Relation::Advisory.def()
    }
}

impl Related<vulnerability::Entity> for Entity {
    fn to() -> RelationDef {
        Relation::Vulnerability.def()
    }
}

impl Related<advisory_vulnerability::Entity> for Entity {
    fn to() -> RelationDef {
        Relation::AdvisoryVulnerability.def()
    }
}

impl ActiveModelBehavior for ActiveModel {}

// score type

#[derive(Debug, Copy, Clone, PartialEq, Eq, EnumIter, DeriveActiveEnum)]
#[sea_orm(rs_type = "String", db_type = "Enum", enum_name = "score_type")]
pub enum ScoreType {
    #[sea_orm(string_value = "2.0")]
    V2_0,
    #[sea_orm(string_value = "3.0")]
    V3_0,
    #[sea_orm(string_value = "3.1")]
    V3_1,
    #[sea_orm(string_value = "4.0")]
    V4_0,
}

// severity

#[derive(
    Debug,
    Copy,
    Clone,
    PartialEq,
    Eq,
    EnumIter,
    DeriveActiveEnum,
    strum::EnumString,
    strum::Display,
    strum::VariantNames,
)]
#[sea_orm(rs_type = "String", db_type = "Enum", enum_name = "severity")]
#[strum(serialize_all = "lowercase")]
pub enum Severity {
    #[sea_orm(string_value = "none")]
    None,
    #[sea_orm(string_value = "low")]
    Low,
    #[sea_orm(string_value = "medium")]
    Medium,
    #[sea_orm(string_value = "high")]
    High,
    #[sea_orm(string_value = "critical")]
    Critical,
}

impl From<cvss3::Severity> for Severity {
    fn from(value: cvss3::Severity) -> Self {
        match value {
            cvss3::Severity::None => Self::None,
            cvss3::Severity::Low => Self::Low,
            cvss3::Severity::Medium => Self::Medium,
            cvss3::Severity::High => Self::High,
            cvss3::Severity::Critical => Self::Critical,
        }
    }
}

impl From<Severity> for cvss3::Severity {
    fn from(value: Severity) -> Self {
        match value {
            Severity::None => Self::None,
            Severity::Low => Self::Low,
            Severity::Medium => Self::Medium,
            Severity::High => Self::High,
            Severity::Critical => Self::Critical,
        }
    }
}

impl From<cvss::Severity> for Severity {
    fn from(value: cvss::Severity) -> Self {
        match value {
            cvss::Severity::None => Self::None,
            cvss::Severity::Low => Self::Low,
            cvss::Severity::Medium => Self::Medium,
            cvss::Severity::High => Self::High,
            cvss::Severity::Critical => Self::Critical,
        }
    }
}

impl From<cvss_old::Severity> for Severity {
    fn from(value: cvss_old::Severity) -> Self {
        match value {
            cvss_old::Severity::None => Self::None,
            cvss_old::Severity::Low => Self::Low,
            cvss_old::Severity::Medium => Self::Medium,
            cvss_old::Severity::High => Self::High,
            cvss_old::Severity::Critical => Self::Critical,
        }
    }
}

impl From<v3::Severity> for Severity {
    fn from(value: v3::Severity) -> Self {
        match value {
            v3::Severity::None => Self::None,
            v3::Severity::Low => Self::Low,
            v3::Severity::Medium => Self::Medium,
            v3::Severity::High => Self::High,
            v3::Severity::Critical => Self::Critical,
        }
    }
}

impl From<v4_0::Severity> for Severity {
    fn from(value: v4_0::Severity) -> Self {
        match value {
            v4_0::Severity::None => Self::None,
            v4_0::Severity::Low => Self::Low,
            v4_0::Severity::Medium => Self::Medium,
            v4_0::Severity::High => Self::High,
            v4_0::Severity::Critical => Self::Critical,
        }
    }
}
