use crate::{
    purl::model::{details::purl::PurlStatus, summary::remediation::RemediationSummary},
    vulnerability::model::VulnerabilityHead,
};
use serde::{Deserialize, Serialize};
use std::{collections::BTreeMap, ops::Deref};
use utoipa::ToSchema;

#[derive(Serialize, Deserialize, Debug, ToSchema)]
pub struct AnalysisRequest {
    pub purls: Vec<String>,
}

#[derive(Serialize, Deserialize, Debug, ToSchema, Default)]
pub struct AnalysisResultV3 {
    pub details: Vec<AnalysisDetailsV3>,
    pub warnings: Vec<String>,
}

#[derive(Serialize, Deserialize, Debug, ToSchema)]
pub struct AnalysisPurlStatus {
    #[serde(flatten)]
    pub purl_status: PurlStatus,
    pub remediations: Vec<RemediationSummary>,
}

#[derive(Serialize, Deserialize, Debug, ToSchema)]
pub struct AnalysisDetailsV3 {
    #[serde(flatten)]
    pub head: VulnerabilityHead,
    /// List of purl statuses & remediations
    pub purl_statuses: Vec<AnalysisPurlStatus>,
}

#[derive(Serialize, Deserialize, Debug, ToSchema)]
pub struct AnalysisResponseV3(pub BTreeMap<String, AnalysisResultV3>);

impl Deref for AnalysisResponseV3 {
    type Target = BTreeMap<String, AnalysisResultV3>;

    fn deref(&self) -> &Self::Target {
        &self.0
    }
}
