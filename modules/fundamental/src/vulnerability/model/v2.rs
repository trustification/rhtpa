use crate::{
    advisory::model::AdvisoryHead, common::model::Score, vulnerability::model::VulnerabilityHead,
};
use serde::{Deserialize, Serialize};
use std::{collections::BTreeMap, ops::Deref};
use utoipa::ToSchema;

#[derive(Serialize, Deserialize, Debug, ToSchema, Default)]
pub struct AnalysisResult {
    pub details: Vec<AnalysisDetails>,
    pub warnings: Vec<String>,
}

#[derive(Serialize, Deserialize, Debug, ToSchema)]
pub struct AnalysisDetails {
    #[serde(flatten)]
    pub head: VulnerabilityHead,

    /// List of purl statuses
    pub status: BTreeMap<String, Vec<AnalysisAdvisory>>,
}

#[derive(Serialize, Deserialize, Debug, ToSchema)]
pub struct AnalysisAdvisory {
    #[serde(flatten)]
    pub advisory: AdvisoryHead,

    /// CVSS scores
    pub scores: Vec<Score>,
}

#[derive(Serialize, Deserialize, Debug, ToSchema)]
pub struct AnalysisResponse(pub BTreeMap<String, AnalysisResult>);

impl Deref for AnalysisResponse {
    type Target = BTreeMap<String, AnalysisResult>;

    fn deref(&self) -> &Self::Target {
        &self.0
    }
}
